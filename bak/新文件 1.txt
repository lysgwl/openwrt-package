if ! git diff-index --quiet HEAD --; then
    status="successful"
else
    status="no_changes"
fi

echo "repo_status=$status" >> $GITHUB_ENV



if [ "$repo_status" != "successful" ]; then
    echo "No changes to commit."
else
    current_date=$(date '+%Y-%m-%d')

    git add .
    git commit -m "Merge code repository on $current_date"
    commit_status=$?

    if [ $commit_status -ne 0 ]; then
        echo "Nothing to commit, working tree clean"
        echo "Checking if local branch is ahead of remote branch..."
        ahead=$(git status | grep 'Your branch is ahead' | wc -l)
        if [ $ahead -ne 0 ]; then
            echo "Local branch is ahead of remote, pushing changes..."
            git push git@github.com:lysgwl/openwrt-package.git HEAD:master
        else
            echo "Local branch is not ahead; no need to push."
        fi
    else
        echo "Changes committed. Proceeding with pull and push."
        git fetch origin master
        
        STATUS=$?
        if [ $STATUS -ne 0 ]; then
            echo "Fetch failed, please check your remote and network."
            exit 1
        else
            git merge FETCH_HEAD
            # 检测是否存在冲突
            if git ls-files -u | grep -q '^'; then
                echo "Merge conflicts detected. Please resolve them manually."
                exit 1
            fi
            
            git push git@github.com:lysgwl/openwrt-package.git HEAD:master 
        fi
    fi
fi